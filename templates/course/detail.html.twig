{% extends 'base.html.twig' %}

{% block body %}
    <div class="container g-0">
        <h1>{{ course.name }}</h1>
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" data-bs-toggle="tab" href="#profil" aria-selected="true" role="tab">Profile</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-bs-toggle="tab" href="#detail" aria-selected="true" role="tab">Détail</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-bs-toggle="tab" href="#commentaires" aria-selected="true" role="tab">Commentaires</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" data-bs-toggle="tab" href="#posterCommentaire" aria-selected="true" role="tab">Postez un commentaire</a>
            </li>

        </ul>
        <div id="myTabContent" class="tab-content">
            <div class="tab-pane fade active show" id="profil" role="tabpanel">
                <div class="row mx-5 my-4">
                    <div class="col-md-4">
                        <img src="{{ (course.image != null)?course.image : asset('images/cours/default.jpg') }}" class="img-fluid rounded-start" alt="{{ course.name }}">
                    </div>
                    <div class="col-md-8">
                        <h3>Description</h3>
                        <p>{{ course.smallDescription|nl2br }}</p>
                        <h3>Informations</h3>
                        {% if course.price != null %}
                            <p>Prix: {{ course.price }} €</p>
                        {% else %}
                            <p>Prix: gratuit </p>
                        {% endif %}
                        <p>Durée: {{ course.duration }}</p>
                        <p>Ajouté le: {{ course.createdAt|date('d/m/Y') }}</p>
                        <p>Horaire: {{ course.program }} </p>
                        <p>Niveau: {{ course.level.name }}</p>
                    </div>

                </div>
            </div>
            <div class="tab-pane fade" id="detail" role="tabpanel">
                <p>Descrition complète</p>
                <p>{{ course.fullDescription|nl2br }}</p>
                <a href="{{ asset('programme/' ~ course.program) }}" type="button" class="btn btn-danger rounded-1">Télécharger le programme</a>
            </div>
            <div class="tab-pane fade" id="commentaires">
                <div class="mx-5 my-4">
                    <h3>Commentaires des abonnés</h3>
                    {% for comment in course.comments|filter(comment => comment.parent is null) %}
                    <div class="d-flex mt-4">
                        <img style="width: 70px; height: 70px;margin-right: 20px" src="{{ (comment.user.image != null)? asset('images/avatar/' ~ comment.user.image) : asset('images/news/default.png') }}" class="img-fluid rounded-circle" alt="{{ comment.user.lastName }}">
                        <div class="border-bottom w-100">
                            <h5>{{ comment.createdAt|date('d/m/Y') }} - {{ comment.user.lastName }}</h5>
                            <div class="textEditor">{{ comment.content|raw }}</div>
                            <p class="my-2"><small>Evaluation de {{ comment.user.lastName }}: ...</small></p>
                            {% if comment.user != app.user %}
                            <button type="button" data-reply data-id="{{ comment.id }}" class="btn btn-info btn-sm">Répondre</button>
                            {% else %}
                                <button type="button" data-update data-id="{{ comment.id }}" class="btn btn-warning btn-sm">Modifier</button>
                            {% endif %}
                        </div>
                    </div>
                        {% if comment.replies|length != 0 %}
                            <div class="mb-5" style="margin-left: 100px">
                            <h5>Les réponses aux commentaires: </h5>
                            {% for reply in comment.replies %}
                            <div class="d-flex mt-4">
                                <img style="width: 70px; height: 70px;margin-right: 20px" src="{{ (reply.user.image != null)? asset('images/avatar/' ~ reply.user.image) : asset('images/news/default.png') }}" class="img-fluid rounded-circle" alt="{{ reply.user.lastName }}">
                                <div class="border-bottom w-100">
                                    <h5>{{ reply.createdAt|date('d/m/Y') }} - {{ reply.user.lastName }}</h5>
                                    <div class="textEditor">{{ reply.content|raw }}</div>
                                    <p class="my-2"><small>Evaluation de {{ reply.user.lastName }}: ...</small></p>
                                    {% if reply.user == app.user %}
                                        <button type="button" data-update data-id="{{ reply.id }}" class="btn btn-warning btn-sm">Modifier</button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="tab-pane fade" id="posterCommentaire">

                <div class="mt-2">
                    {{ form_start(form)}}
                    {{ form_widget(form) }}
                    <label for="{{ form.content.vars.id }}" class="my-2">laissez un commentaire:</label>
                    <trix-editor input="{{ form.content.vars.id }}" class="trix-content" required></trix-editor>
                    <input type="submit" value="Envoyer" class="btn btn-danger mt-2">
                    {{ form_end(form)}}

                </div>
            </div>
        </div>
    </div>
    <script>
        window.onload = ()=>{
            document.querySelectorAll("[data-reply]").forEach(element =>{
                element.addEventListener('click', ()=>{
                   document.querySelector('#comment_parentId').value = element.dataset.id;
                   document.querySelector("a[href='#posterCommentaire']").click();
                });
            });

            document.querySelectorAll("[data-update]").forEach(element =>{
                element.addEventListener('click', ()=>{
                    document.querySelector('#comment_updateId').value = element.dataset.id;

                    document.querySelector("trix-editor[input='comment_content']").innerHTML= element.parentElement.querySelector('.textEditor').innerHTML
                    document.querySelector("a[href='#posterCommentaire']").click();
                });
            });

        };
    </script>
{% endblock %}
